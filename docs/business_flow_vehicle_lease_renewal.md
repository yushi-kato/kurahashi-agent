# 業務フロー: 車両リース契約 更新通知（GAS）

## 1. 目的
契約満了が近い車両を自動抽出し、管理部署へ通知→Webで回答回収→集計→台帳へ反映までを省力化する。

対象の仕組み（実装計画）は `docs/plan_vehicle_lease_renewal_gas.md` を参照。

---

## 2. 登場人物（役割）
- 管理部署（現場/利用部署）
  - 車両ごとに「更新方針（再リース/新車入替/廃止/未定）」を回答する
- 車両管理者（本社/管理側）
  - 集計を確認し、リース会社への連絡（営業メモ③）を実施する
  - 必要に応じて台帳の補正（誤記や不足の是正）を行う
- システム管理者（GAS/シート管理）
  - `部署マスタ` や `設定` のメンテ、スキーマ同期、障害時の復旧を行う

---

## 3. データの置き場（業務で触る場所）
- 台帳（インポート結果）:
  - `車両一覧` / `車両一覧【ｹﾝｽｲ】` / `車両一覧【ﾈｸｽﾄ】`
- マスタ/運用シート（GASが作成・更新）:
  - `部署マスタ`（管理部門の表記統一・通知先メール・トークン）
  - `設定`（抽出月数、リマインド間隔、集計ON/OFF、管理者宛先など）
  - `更新依頼`（部署単位の依頼とステータス）
  - `回答`（車両単位の回答ログ）
  - `回答集計`（管理者向けサマリ）
  - `要入力`（契約満了日などが欠けているデータのリスト）
  - `通知ログ`（送信やエラーの記録）

---

## 4. フロー全体（To-Be）
### 4.1 定期実行（自動）
1) 車両データを統合・正規化する（台帳3シート→統合ビュー）  
2) 「本日〜本日+6か月」で満了する車両を抽出する  
3) 管理部門ごとに「更新依頼（requestId）」を作成する  
4) 管理部門へメール送信（Web回答リンク付き）  
5) 未回答の管理部門へリマインド（間隔/最大回数は `設定` で可変）  
6) 回答状況を集計し、(a) `回答集計` シート更新 + (b) 管理者へサマリメール送信（`設定` でON/OFF）  

### 4.2 管理部署の作業（回答）
1) 通知メールを受け取る  
2) メール内リンクからWeb画面を開く（リンク+トークン方式）  
3) 対象車両ごとに「更新方針」を選択し、必要ならコメントを添えて送信  
4) 送信後、回答済みとして記録される（`回答`/`更新依頼` が更新される）  

### 4.3 車両管理者の作業（集計確認→連絡→反映）
1) `回答集計` で部署別の状況を確認（未回答/未定が残っていないか）  
2) 必要に応じて管理部署へ確認（GASの範囲外でもOK）  
3) 集計が揃ったら、リース会社へ連絡（営業メモ③、人手作業）  
4) 結果に応じて、台帳（まず `車両一覧`）に反映されていることを確認する  

---

## 5. 例外フロー（運用で詰まりやすい所）
### 5.1 `契約満了日` が無い車両がある
- 仕様: 抽出対象外にし、`要入力` に「契約満了日なし」として出す
- 対応: 車両管理者（または管理部署）が台帳側の該当車両へ満了日を入力（次回抽出から対象化）

### 5.2 `管理部門` が未設定 / `部署マスタ` に存在しない
- 仕様: 抽出自体は可能だが、通知先が決められないため `要入力` に出す（通知はしない）
- 対応:
  - 台帳の `管理部門` を `部署マスタ` の表記に合わせて修正（表記統一はマスタ側が正）
  - または `部署マスタ` に新規追加（通知先メールとトークンを設定）

### 5.3 回答リンク（トークン）の漏洩/転送が心配
- 仕様: ログイン必須にせず「リンク+トークン」で検証するため、リスクはゼロにはならない
- 対応（運用）:
  - トークンは十分に長いランダム値にする（`部署マスタ` と `更新依頼` の二重トークン）
  - 漏洩が疑われる場合は、該当依頼のトークンを再発行して旧リンクを無効化（実装側で用意）

### 5.4 未回答が続く
- 仕様: `設定` に基づきリマインドを送る（間隔/最大回数は後から変更可能）
- 対応: 管理者は `回答集計` の未回答を確認し、必要なら個別に督促（最終手段）

---

## 6. 運用ルール（最低限）
- `部署マスタ` の「管理部門」表記を正として運用する（台帳側の揺れは都度直す）
- 台帳の列追加/列移動が起きても壊れないように、参照は列番号固定ではなくヘッダ名ベースで行う
- まずは `車両一覧` への反映までを正とし、`更新` シート連携は次フェーズで検討する

---

## 7. 期待する成果物（最終的に現場が見えるもの）
- 管理部署: メール + Web画面で「対象車両と回答フォーム」
- 車両管理者:
  - `回答集計` シートで部署別の状況（再リース/新車入替/廃止/未定/未回答）
  - 管理者メールで同内容のサマリ（設定でON/OFF）
- データ品質:
  - `要入力` シートで「満了日なし」などの不備が一覧化される

