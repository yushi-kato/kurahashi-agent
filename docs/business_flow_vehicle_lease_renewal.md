# 業務フロー: 車両リース契約 更新通知（半期一括運用）

## 1. 目的
契約満了が近い車両を半期ごとに一括抽出し、本部長/副本部長の確認 → 専務承認 → 台帳反映までをシート運用で完結させる。

対象の実装計画は `docs/plan_vehicle_lease_renewal_hq_biannual_confirmation.md` を参照。

---

## 2. 登場人物（役割）
- 本部長 / 副本部長
  - 確認用シートで車両ごとの方針（更新/解約）を入力し、`回答確認済み` を付ける
- 専務
  - 確認用シートの `専務判断` / `専務コメント` を入力して承認・差戻しを確定する
- 村田主任（車両管理）
  - 承認済み行に対して、更新日付/解約完了の入力を行い、台帳へ反映を完了させる
- システム管理者
  - `設定` やスキーマ同期、通知ログ監視、障害時の復旧を行う

---

## 3. データの置き場（業務で触る場所）
- 台帳（唯一のマスター）
  - `車両一覧`
- 運用シート（GASが作成・更新）
  - `設定`（通知先/半期日付/期限/リマインド日数など）
  - `通知バッチ`（半期ごとの送付単位）
  - `本部長副本部長確認_YYYYMMDD`（確認用シート）
  - `要入力`（満了日など必須情報が欠けている車両の一覧）
  - `通知ログ`（送信・反映・エラーの記録）

---

## 4. フロー全体（To-Be）
### 4.1 半期バッチの作成
1) 3月1日または9月1日にバッチを作成する
2) 対象抽出は「半期レンジ + 過去の未反映分」
   - 3月便: 当年10/1〜翌年3/31 + それ以前の未反映分
   - 9月便: 当年4/1〜9/30 + それ以前の未反映分
3) 対象車両から `本部長副本部長確認_YYYYMMDD` シートを生成する

### 4.2 本部長/副本部長の確認
1) 初回通知を送信（両名を To に設定）
2) 期限10日前に未確認が残っていれば1回だけリマインド
3) 全件 `回答確認済み` になったら、専務へ承認依頼を送信

### 4.3 専務承認
1) 専務が確認用シートの `専務判断`（承認/差戻し）を入力する
2) 必要に応じて `専務コメント` を記入する

### 4.4 反映（村田主任）
1) 承認済み行に対して、以下を入力する
   - 更新: `新契約開始日` / `新契約満了日`
   - 解約: `解約完了` チェック
2) GAS が `車両一覧` へ反映する
   - 更新: 契約開始日 / 満了日を上書き
   - 解約: 対象行をグレーアウト
3) `マスター反映済み` / `反映日時` を記録して重複反映を防止する

---

## 5. 例外フロー（運用で詰まりやすい所）
### 5.1 `契約満了日` が無い車両がある
- 仕様: 抽出対象外にし、`要入力` に「契約満了日が未設定」として出す
- 対応: 台帳側で満了日を入力し、次回バッチで対象化する

### 5.2 通知先が未設定
- 仕様: `本部長副本部長_通知先To` / `専務_通知先To` が空の場合は送信しない
- 対応: `設定` シートの通知先を更新する

### 5.3 専務判断列の誤編集
- 仕様: `専務判断` / `専務コメント` は専務以外が編集できないよう列保護する
- 対応: 保護が外れた場合は日次処理で再設定する

---

## 6. 運用ルール（最低限）
- 台帳は `車両一覧` のみを正とする
- 参照は列番号固定ではなくヘッダ名ベースで行う
- 半期バッチは 3月/9月の送付日に作成する

---

## 7. 期待する成果物（最終的に現場が見えるもの）
- 本部長/副本部長: 確認用シートで更新方針の判断と確認済み入力
- 専務: 確認用シートで承認/差戻し入力
- 車両管理者: `車両一覧` の更新/グレーアウト反映と `通知ログ` による履歴追跡
