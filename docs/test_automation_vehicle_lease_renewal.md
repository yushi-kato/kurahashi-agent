# AI向け手順書: 車両更新通知（GAS）テスト自動化の流れ

## 0. 目的

スプレッドシート上の手作業（データ入力・確認・メニュー操作）を最小化し、
「テスト → 結果確認 → デバッグ」のループを **できるだけ自動**で回せるようにする。

本ドキュメントは、AI が作業を引き継いでも同じ手順で回せる「運用・検証の手順書」を兼ねる。

---

## 1. 相談事項（決めると自動化が進む）

1) **テストは本番シートで行う？複製（テスト用）で行う？**
   - 推奨: 本番スプレッドシートを複製して「テスト用」で実施（誤送信・誤反映の事故を避ける）
2) **メール送信（MailApp）はテストで実際に送る？**
   - `設定.通知_メール送信` で ON/OFF できる（OFF 推奨。必要時だけON）
3) **Playwright で Web回答（ブラウザ操作）まで自動化する？**
   - 可能だが、Googleログイン/2FA/権限周りの整備が必要になりやすい

---

## 2. 自動化の全体像（3レイヤー）

### レイヤーA: GAS 内部テスト（最優先・最小コスト）

GAS の関数で以下を一括実行し、結果を `テスト結果` シートに残す。

- `runTestSuite()`（テスト一括）
- `diagnoseSourceSheets()`（ヘッダ診断）
- `seedTestVehicles()`（テスト車両投入）
- `generateDeptTokens()`（部署トークン空欄生成）

メリット: UI操作をほぼ排除できる（メニュー1回 or CLIから実行）。

### レイヤーB: CLI（clasp）で “ビルド→push→テスト実行” を自動化

ローカルから次を流し込み、結果は `テスト結果` を見ればよい状態にする。

- `npm run build`
- `clasp push -f`
- （可能なら）`clasp -u runscope run runTestSuite`
- （結果回収）`clasp -u runscope run exportTestResults --params "[200]"`（JSON文字列が返る）

※ `clasp run` は Apps Script API と OAuth/Workspace 制限の都合で使えない場合がある。使えない場合は「シートのメニューから `runTestSuite` 実行」を残す。

#### 重要: `clasp run` が 403 / “このアプリはブロックされます” になる場合

- まず `.clasp.json` に `projectId` が入っていること（GCP紐づけ）
- GCP（対象プロジェクト）で `script.googleapis.com`（Google Apps Script API）を有効化
- Google Workspace で “このアプリはブロックされます” になる場合は、**自前の OAuth クライアント**で `clasp login` する
  - GCPで OAuth クライアントID（種類: **デスクトップアプリ**）を作成して JSON をDL（先頭が `"installed"` の形式）
  - 例: `clasp login -u runscope --creds ./client_secret_xxx.json --use-project-scopes`
  - 以降の実行は `clasp -u runscope run ...`
- `clasp run runTestSuite` が `No response.` と出ることがあるが、`テスト結果` / `exportTestResults()` で結果確認できる

#### 重要: `exportTestResults()` が “配列” を返さない理由

Apps Script Execution API（`clasp run`）は返却値の型に制約があるため、`exportTestResults()` は **JSON文字列**を返す。

### レイヤーC: Playwright（任意）で Web回答まで E2E 自動化

「メールURLを開いて回答送信」まで自動化する。これをやると回帰が潰しやすい。

ただし、Googleログイン（組織アカウント、2FA）次第で運用コストが上がるため、段階的に導入する。

---

## 3. テストの流れ（推奨ループ）

### 3.1 1回のループ（最短）

1) ローカルでビルド: `npm run build`
2) GASへ反映: `clasp push -f`
3) スプレッドシートでメニュー → **「テスト一括実行(メール送信は設定次第)」**
4) `テスト結果` を確認（NGがあれば原因の項目へ）

### 3.3 テストデータの掃除

台帳/統合ビュー/要入力/更新依頼/集計などに残った `TEST...` 系のテストデータを削除する。

- スプレッドシートでメニュー → **「テストデータ掃除」**
- CLIなら `clasp -u runscope run cleanupTestData`

### 3.2 期待する成果物（確認箇所）

- `テスト結果`: テストの実行ログ（OK/NGの粒度は今後拡張）
- `要入力`: 満了日なし/管理部門なし/部署未登録が検出されているか
- `車両（統合ビュー）`: 正規化ができているか（依頼IDや更新方針の反映先）
- `更新依頼`: 部署単位で依頼が作られるか（期限内のみ）
- `通知ログ`: 送信ON時の結果、送信OFF時のスキップログ

---

## 4. デバッグの基本手順（NGのとき）

### 4.1 seedTestVehicles が 0件 / 未処理シートになる

原因: 台帳シート（`車両一覧` 等）のヘッダが想定と違い、必須列が解決できない。

対応:
1) メニュー → **「ソースシート診断」** を実行
2) `テスト結果` の診断ログ（JSON）と Logger を確認
3) 足りないヘッダ名があれば、`resolveSourceHeaders()` の alias に追加する

※ インポート元Excel由来の表記ゆれが起きやすい（例: `分類番号（３桁）` 等）。
※ 台帳が「登録番号」1列（分割列なし）の場合は `registrationMode: combined` になり、現実装ではそのまま処理できる。

---

## 5. 自動化の実装状況（2026-01-18時点）

### 実装済み

- `generateDeptTokens()`：`部署マスタ.部門トークン` 空欄だけ自動生成
- `seedTestVehicles()`：台帳3シートへテスト車両を投入（期限内/期限外/満了日なし/管理部門なし/部署未登録）
- `diagnoseSourceSheets()`：台帳3シートのヘッダ解決状況を診断し、`テスト結果` に保存
- `runTestSuite()`：上記を含む簡易一括実行（メール送信は `設定.通知_メール送信` に従う）
- `テスト結果`：テスト用ログ出力シート

### 今後の拡張（優先順）

1) **テスト結果の“期待値チェック”を増やす**
   - 期限内/期限外の抽出件数が想定どおりか（6ヶ月の月加算・端数処理含む）
   - `要入力` の検出件数（満了日なし/管理部門なし/部署未登録）
   - `更新依頼` の生成件数（部署単位・重複防止）
2) **メール送信の完全な Dry-run 化**
   - 送信せずに「送るはずの宛先/件名/本文/URL」を `メール下書き` シートに出す
3) **Playwright E2E**
   - `メール下書き` からURLを取得→Web回答→`回答`/`台帳`反映を検証

---

## 6. AIが作業するときの注意（事故防止）

- 本番シートでテストを回す場合、`設定.通知_メール送信` は必ず OFF にしてから実行する
- `seedTestVehicles()` は台帳に行を追加するため、可能ならテスト用スプレッドシートで実施する
- ドリフト（ヘッダ名変更）が起きたら、まず `diagnoseSourceSheets()` で現状把握してから修正する
