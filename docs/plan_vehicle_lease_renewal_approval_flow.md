# 改善計画書: 車両リース管理自動化（承認/差戻しフロー追加）

- 作成日: 2026-02-02
- 対象: 本リポジトリの「車両リース契約 更新通知（GAS）」一式
- 背景資料:
  - 参考メール: `docs/references/2026-01-27_vehicle-lease-automation_email/email_body.md`
  - 既存計画: `docs/plan_vehicle_lease_renewal_gas.md`
  - 既存業務フロー: `docs/business_flow_vehicle_lease_renewal.md`
  - 実装（現状）: `src/main.ts`

## 1. 目的 / 成功条件

### 目的
`docs/references/2026-01-27_vehicle-lease-automation_email/email_body.md` にあるような、
「一次確認 → 専務承認（差戻しあり）→ 車両管理担当へ結果通知 →（人手で）リース会社連絡 → 完了フラグ」
の流れを、現行の仕組みに無理なく取り込む。

### 成功条件（受け入れ条件）
- 一次確認者（本部長/副本部長等）へ「対象車両一覧 + 回答フォーム」を送れる
- 一次回答結果を集約し、専務（承認者）へ「承認/差戻し」できる形で提示できる
- 承認結果が、車両管理担当者（例: 村田主任）へ「結果通知」として届く
- 差戻し時に「誰へ・どう戻すか」が運用/データ上で明確で、再回答が回せる
- 最終的に「完了（リース会社連絡済み等）」の状態を、車両単位または依頼単位で追える

## 2. 非目的（今回やらないこと）
- リース会社への連絡をGASが自動送信する（集計/結果通知までに留める）
- 監査要件レベルの厳密なワークフロー（電子稟議/改ざん防止など）

## 3. 前提 / 制約
- GAS Webアプリは使わず、回答はGoogleフォーム中心（現状: `src/main.ts` はWeb回答を廃止メッセージにしている）
- 本番スプレッドシートは人が触る前提のため、スキーマ変更は「列追加中心・非破壊」を優先（`docs/sheet_schema_management_rules.md`）
- 送信クォータ/誤送信対策として、通知は「グループ単位で1通」に寄せるのが基本方針

## 4. 現状（調査結果 / As-Is）

### 現状のフロー（要約）
- `車両（統合ビュー）` を生成し、満了が近い車両を `管理部門` ごとに `更新依頼`（requestId）へまとめる
- requestIdごとにGoogleフォームを作成し、部署宛に「フォームURL」をメール送信する（一次回答）
- フォーム送信トリガーで `回答` を更新し、`車両（統合ビュー）` と台帳へ反映、`回答集計` を更新する
- ただし「承認/差戻し」や「車両管理担当へ結果通知」「完了フラグ」は、要件としてはあるが仕組みとしては未確立

### 4.1 参考画像から読み取れる“指示”（docs/references 添付）
※個人名/メールアドレス等はここでは記載しない。

- `docs/references/2026-01-27_vehicle-lease-automation_email/attachments/image003.png`
  - 台帳の基本カラム例: `管理部門` / `管理担当者` / `登録番号（分割）` / `車種` / `車台番号` / `契約開始日` / `契約満了日` / `契約期間` / `車検満了日` / `リース料（税抜）`
- `docs/references/2026-01-27_vehicle-lease-automation_email/attachments/image004.png`
  - 一次確認のフォーム例: 車両ごとに選択（ラジオ）
  - 選択肢: `更新` / `解約（入替）` / `解約（満了）`（=3択、未定は無し）
- `docs/references/2026-01-27_vehicle-lease-automation_email/attachments/image008.png`
  - 台帳例に「一次確認結果」っぽい列が追加されている（例: `本部回答`）
- `docs/references/2026-01-27_vehicle-lease-automation_email/attachments/image007.png`
  - 承認フォーム例: 「一次結果（例: 更新）」に対して `承認` / `差し戻し` を選ぶ（ラジオ）
- `docs/references/2026-01-27_vehicle-lease-automation_email/attachments/image011.png`
  - 結果が一覧化されたシート例（左端に結果らしき列が並ぶ）
  - 送付先としてメールアドレス列が存在する運用が示唆される

### 主要な現状要素
- データ（シート）: `設定` / `部署マスタ` / `車両（統合ビュー）` / `更新依頼` / `回答` / `通知ログ` / `回答集計`（`src/main.ts`）
- 依頼ステータス: `作成済/送信済/回答中/完了/締切`（`src/main.ts`）
- 通知種別（ログ）: 初回/リマインド/期限超過など（`src/main.ts`）

## 5. To-Be（方針 / 設計概要）

### 5.1 追加したい業務ステップ（メール参照）
参考メールの To-Be は、ざっくり次を追加するイメージ。

1) 一次確認（本部長/副本部長等）へ対象一覧送付 → 回答回収  
2) 承認者（専務）へ一次結果を提示 → 承認 or 差戻し  
3) 車両管理担当へ「承認結果」を通知  
4) （人手）リース会社へ連絡  
5) 完了フラグを立てる → 台帳/管理表へ反映

### 5.1.1 今回の前提（決定済みの運用）
- 一次確認の回答者: 本部長/副本部長（一次確認者）
- 専務承認の粒度: 基本は依頼単位、必要なら車両単位で差戻し（ハイブリッド）
- 差戻しの戻し先: 一次確認者へ戻して再回答
- 選択肢ラベル: 4択は維持しつつ「更新/解約」表現へ寄せる
- 送付タイミング: ローリング/バッチの両対応（設定で切替）
- 完了フラグ: 車両単位で完了（車両管理担当がチェック）

### 5.2 データ設計（追加案）
既存の `更新依頼`/`回答` を活かしつつ、承認段を表現するデータを追加する。
「既存シートに列追加」か「新規シート追加」かは判断ポイント（後述）。

追加候補（例）:
- 依頼単位（部署/グループ単位）
  - `承認ステータス`（未送付/承認待ち/承認済/差戻し）
  - `承認依頼送信日時` / `承認日時`
  - `承認者`（表示名/メール）
  - `差戻しコメント`
  - `承認フォームURL`（フォーム方式の場合）
- 車両単位（`車両（統合ビュー）`）
  - `一次回答`（例: 本部長/副本部長の回答。参考画像の `本部回答` に相当）
  - `最終決定`（更新/解約(入替)/解約(満了) など）
  - `完了フラグ` / `完了日`
  - `完了メモ`（任意）

### 5.3 通知設計（宛先の整理）
メール本文の登場人物が増えるため、宛先を「マスタ/設定」で管理できるようにする。

- 一次確認者（本部長/副本部長等）: 部署/グループに紐づく宛先
- 承認者（専務）: 原則固定（設定で1箇所）
- 車両管理担当（村田主任等）: 原則固定（設定で1箇所）

※ 既存の `部署マスタ` は「管理部門→通知先To/Cc」を持っているが、これを一次確認者に転用するか、
別シートで「承認ルート」を持つかが判断ポイント。

### 5.4 処理フロー（案）
最終的なTo-Beは「二段階フォーム」か「承認はシートで行う」かで変わる。

- 案A: 一次回答=フォーム、承認=フォーム（メールに承認フォームURL）
  - メリット: 承認者がメールから完結できる
  - デメリット: フォームが増える/承認UIが作りにくい（一次結果の“転記”が必要）
- 案B: 一次回答=フォーム、承認=スプレッドシート上のチェック（承認用ビュー）
  - メリット: 一次結果をそのまま見せられる（集計/差戻しコメントも管理しやすい）
  - デメリット: 承認者がシートを開く運用になる（権限/閲覧範囲の調整が必要）

推奨は案B（フォーム増殖と転記を避け、運用の見える化を優先）。

### 5.4.1 承認入力（参考画像との対応）
参考画像（`image007.png`）の通り、承認者の入力は最低限以下を想定する。
- 承認: `承認` / `差し戻し`
- コメント: 差戻し理由（任意→必要なら必須）

### 5.5 送付タイミング（ローリング/バッチ両対応）
- ローリング（現行寄り）: 「本日〜本日+Nか月」で日次作成/送付
- バッチ（メール記載寄り）: 例）2月に1年分、または2月/8月の半期単位で作成/送付
- 実装は「設定で切替」できる設計にし、運用開始時のデフォルトは別途決める

### 5.6 選択肢ラベル（更新/解約表現）
参考メールの表現に合わせ、対外的には以下のように表現する（4択は維持）。
- 更新（再リース）
- 解約（入替）
- 解約（満了）
- 未定

補足:
- 参考画像（`image004.png`）の一次フォーム例は3択（未定なし）だが、今回は4択を維持する前提。
- 内部の保存値（シート/集計）をこの表現に揃えるか、既存の `再リース/新車入替/廃止/未定` を継続して「表示だけ変える」かは、実装フェーズで確定する。

## 6. 判断ポイントと決定事項

この章は、打ち合わせ（メール送付前の認識合わせ）で決まった内容を反映する。

| ID | 判断ポイント | 決定 | 採用案 |
|---|---|---|---|
| 1 | 一次確認の回答者 | 決定 | B |
| 2 | 専務承認の粒度 | 決定 | C |
| 3 | 差戻し時の戻し先 | 決定 | A |
| 4 | 選択肢ラベル | 決定 | C |
| 5 | 送付タイミング | 決定 | C |
| 6 | 完了フラグの粒度 | 決定 | A |

### Q1. 「一次確認の回答者」は誰にする？
- 背景: 現状は `管理部門` 宛に依頼を送るが、参考メールは「本部長/副本部長」が一次確認者。
- 選択肢:
  - A) 現状維持（管理部門が回答）
  - B) 変更（本部長/副本部長が回答）※参考メール寄り
  - C) 二段（管理部門が案→本部長/副本部長が確定）
- 影響: 宛先マスタ設計、誰が現場判断をするか、差戻しの流れ
- 決定: B（一次確認は本部長/副本部長が回答する）

### Q2. 承認（専務）の粒度は？
- 背景: 「承認/差戻し」を車両単位でやるか、依頼（部門/グループ）単位でやるかでUIが変わる。
- 選択肢:
  - A) 依頼単位で一括承認/差戻し（差戻しコメントは共通）
  - B) 車両単位で承認/差戻し（コメントも車両ごと）
  - C) ハイブリッド（基本は依頼単位、例外のみ車両単位）
- 影響: シート/フォーム設計、工数、運用の負荷
- 決定: C（基本は依頼単位、必要があれば車両単位で差戻しできる余地を残す）

### Q3. 差戻し時の“戻し先”はどこ？
- 背景: 参考メールでも「差戻しがどのように送付されるのか？」が未確定。
- 選択肢:
  - A) 一次確認者へ戻す（本部長/副本部長に再回答依頼）
  - B) 車両管理担当へ戻す（管理側で補正して再提示）
  - C) システム管理者がハンドリング（データ修正/再送）
- 影響: 再回答の責任範囲、運用のスピード、説明コスト
- 決定: A（差戻しは一次確認者へ戻して再回答してもらう）

### Q4. 選択肢（更新/解約）の表現はどれに合わせる？
- 背景: 現状は `再リース/新車入替/廃止/未定`。参考メールは `更新/解約(入替)/解約(満了)`。
- 選択肢:
  - A) 現状維持（4択）
  - B) 参考メールへ寄せて3択にする（未定をやめる）
  - C) 4択のままラベルを寄せる（例: 更新(再リース)/解約(入替)/解約(満了)/未定）
- 影響: 過去データとの整合、現場が迷う/迷わない、集計表
- 決定: C（4択のまま、表現を「更新/解約」に寄せる）

### Q5. 送付のタイミングはどうする？
- 背景: 参考メールには「2月に1年分？半年ごと？」がある。現状は「本日〜本日+6か月」を日次運用。
- 選択肢:
  - A) 日次（ローリング）: 常に6か月先までを対象
  - B) 年次/半期バッチ: 2月に1年分、または半年ごと
  - C) 両対応: 設定でどちらも選べる（運用に応じて）
- 影響: 対象期間の定義、依頼の粒度（requestIdの発生頻度）、リマインド設計
- 決定: C（両対応できる設計にする。運用開始時はどちらで回すかは別途決める）

### Q6. 「完了フラグ」は何をもって完了にする？
- 背景: 参考メールの「リース会社に連絡→完了フラグ」は、ツールの範囲外作業が間に挟まる。
- 選択肢:
  - A) 車両単位で完了（車両管理担当がチェック）
  - B) 依頼単位で完了（グループ/部門単位で締める）
  - C) `更新` シート（進捗管理）と連携して完了を決める（次フェーズ寄り）
- 影響: UI/運用、完了の抜け漏れ検知、既存台帳との関係
- 決定: A（車両単位で完了。車両管理担当がチェックして抜け漏れを防ぐ）

## 7. 実装ステップ（手順）

### フェーズ1: 承認フローの“見える化”を先に作る（最小の価値）
1) 承認/差戻しの状態を保持するため、スキーマ（列 or 新規シート）を追加
2) 一次回答→集計→「承認待ち一覧」を作る（スプレッドシート上のビュー）
3) 承認待ち一覧から、承認者へ「一覧リンク + 差戻しの運用説明」をメール送信できるようにする
4) 承認/差戻しをシート操作で反映し、車両管理担当へ結果通知メールを送る

### フェーズ2: 差戻しループを安定させる
1) 差戻しコメントの入力欄/記録先を確定
2) 差戻し発生時に、一次確認者へ「差戻し通知 + 再回答手順」を自動送信
3) 再回答（フォーム再送信 or 再作成）を決め、ステータス遷移を整備

### フェーズ3: 完了フラグと運用の仕上げ
1) 完了フラグ（車両単位/依頼単位）を追加し、一覧で追えるようにする
2) `docs/operation_manual_vehicle_lease_renewal.md` を「承認/差戻し/完了」に対応させて更新
3) `runTestSuite()` に承認フローの期待値チェックを追加（可能な範囲で）

## 8. 影響範囲（変更点一覧）
実装する場合の主な影響範囲（候補）:
- `src/main.ts`（スキーマ/状態/通知/集計の拡張）
- `docs/operation_manual_vehicle_lease_renewal.md`（運用追加）
- `docs/business_flow_vehicle_lease_renewal.md`（登場人物/To-Be更新）

## 9. リスクと対策
- リスク: 承認者がシートを開かない/見落とす
  - 対策: 承認待ちの件数/期限をメール件名に入れる、期限超過通知を追加
- リスク: 差戻しの責任範囲が曖昧で止まる
  - 対策: Q3を先に決め、差戻しメールのテンプレに「次アクション」を明記
- リスク: フォーム/トリガー増殖（上限/運用負荷）
  - 対策: 承認は原則シート運用（案B）、フォームは一次回答に限定

## 10. テスト/検証（方針）
- 既存の `docs/test_automation_vehicle_lease_renewal.md` の流れを踏襲し、まずはGAS内部テスト（`runTestSuite()`）を拡張する。
- 承認ステータスの遷移と「通知ログが期待通り残る」ことを最小の自動検証範囲とする。

## 11. ロールバック（戻し方）
- スキーマは列追加中心にし、既存フロー（一次回答→反映→集計）を壊さない形で進める。
- もし承認フローが運用に合わない場合は「承認ステータスを無視して現行通り送る」設定で段階的に戻せるようにする（実装時の方針）。

## 12. 未解決 / 追加の確認事項
- 一次確認者（本部長/副本部長等）は「管理部門ごとに異なる」で良いか、それとも「全社で固定」か（宛先マスタ設計に影響）
- 承認者（専務）が「差戻し」した場合、一次回答のフォームは再回答を許可するか（再送信/再作成/締切延長）
- 承認者が“部分承認”したいケースがあるか（車両ごとの差戻しが必要か）
- 車両管理担当が最終的に更新会社へ連絡した後、どの台帳/シートに「完了」を残すのが運用上正か（`車両一覧` 右端追記で足りるか、`更新` シート連携が必要か）
