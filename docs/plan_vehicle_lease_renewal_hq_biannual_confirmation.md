# 実装計画書: 契約満了通知フローの半期一括運用への変更（確定版）

- 作成日: 2026-02-06
- 更新日: 2026-02-06
- 対象リポジトリ: `/Users/yushi/work/work/クラハシ`
- 対象実装: `/Users/yushi/work/work/クラハシ/src/main.ts`

## 1. 目的（何を変えるか）
- 通知単位を「管理部門ごとの都度依頼」から「年2回の全社一括依頼」へ変える。
- 回答を「確認用シート中心」に一本化し、専務判断もシート入力で確定できるようにする。
- 台帳は `車両一覧` へ統合し、`車両一覧【ｹﾝｽｲ】` / `車両一覧【ﾈｸｽﾄ】` / `車両（統合ビュー）` 依存をなくす。

## 2. 背景（用語を意味から整理）
- `依頼`:
  - 旧: 管理部門ごとに作る requestId。
  - 新: 半期ごとに作る「送付バッチ」。
- `確認`:
  - 旧: Googleフォーム回答を受け取ること。
  - 新: 確認用シート上で、本部長/副本部長が車両ごとに判断し、`回答確認済み` を付けること。
- `承認`:
  - 旧: 承認フォーム送信で確定。
  - 新: 専務が確認用シートの `専務判断` 列を入力して確定。
- `完了`:
  - 専務承認後に、村田主任が必要入力（更新日付 or 解約完了）を満たし、`車両一覧` に反映し終えた状態。

## 3. 決定事項（ユーザー確定）
1. 専務の `承認/差戻し` はメール返信ではなく、確認用シート入力で確定する。
2. 本部長/副本部長通知は、両方 `To` に入れる（Ccは使わない）。
3. 台帳は `車両一覧` のみを使用し、他台帳シートと3シート統合用シートは使わない。
4. 「今〜12ヶ月」は固定半期レンジに読み替える。ただし、そのレンジ以前の未処理車両も対象に含める。
5. 専務が触る列（`専務判断` / `専務コメント`）は、専務以外が編集できないように列保護する。

## 4. 新フロー（To-Be）
### 4.1 送付タイミング
- 3月1日送付、3月31日までに専務承認完了。
- 9月1日送付、9月30日までに専務承認完了。

### 4.2 抽出ルール
- 3月便:
  - 基本対象: 当年10月1日〜翌年3月31日満了。
  - 追加対象: 上記より前の満了日で、未処理（未反映）の車両。
- 9月便:
  - 基本対象: 当年4月1日〜当年9月30日満了。
  - 追加対象: 上記より前の満了日で、未処理（未反映）の車両。
- つまり「半期レンジ + 過去取りこぼし回収」で運用する。

### 4.3 通知と進行
1. 半期バッチを作成する。
2. 対象車両から `本部長副本部長確認_YYYYMMDD` シートを生成する。
3. 本部長/副本部長へ確認依頼メールを送る（`To` に2名）。
4. 期限10日前時点で `回答確認済み` が未完了なら、リマインドを1回だけ送る。
5. 全件 `回答確認済み` になったら、専務へ承認依頼メールを送る。
6. 専務が確認用シートへ `承認/差戻し` を入力する。
7. 承認済み行について、村田主任が以下を入力する。
- 更新: `新契約開始日` と `新契約満了日`
- 解約: `解約完了` チェック
8. `車両一覧` に反映する。
- 更新: 日付を上書き
- 解約: 対象行をグレーアウト

## 5. 確認用シート設計（image003ベース + 追加列）
- 既存列（画像ベース）:
- 管理部門
- 管理担当者
- 登録番号
- 車種
- 車台番号
- 契約開始日
- 契約満了日
- 契約期間
- 車検満了日
- リース料（税抜）
- 追加列:
- 本部回答（`更新 / 解約（入替） / 解約（満了）`）
- 回答確認済み（チェックボックス）
- 専務判断（`承認 / 差戻し`）
- 専務コメント
- 新契約開始日（更新時必須）
- 新契約満了日（更新時必須）
- 解約完了（解約時必須）
- マスター反映済み
- 反映日時

### 5.1 列保護ルール（専務列）
- 保護対象:
- `専務判断`
- `専務コメント`
- 編集許可:
- 専務メールアドレス（設定値 `専務_通知先To`）
- スクリプト実行ユーザー（自動処理が更新できるようにする）
- 編集不可:
- 本部長/副本部長、村田主任、その他利用者
- 運用ルール:
- 確認用シート生成時に必ず保護を設定する。
- ヘッダ再作成や列追加後に保護が崩れないよう、日次処理でも保護再適用する。

## 6. 既存機能の必要 / 不要整理
### 6.1 継続利用（必要）
- スキーマ同期基盤（`syncSchema` / `ensureHeaders`）
  - 理由: 新列・新シートを安全に配備するため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:294`
- 通知ログ（`通知ログ` + `appendNotificationLog`）
  - 理由: 送信実績と失敗理由を追跡するため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:3957`
- メール送信ON/OFF設定（`通知_メール送信`）
  - 理由: 検証時の誤送信防止のため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:214`

### 6.2 仕様変更して継続（必要だが作り替え）
- `createRequests`
  - 変更: 半期バッチ作成 + 固定半期レンジ + 過去未処理回収へ変更。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:538`
- `sendInitialEmails`
  - 変更: 部署マスタ宛から、本部長/副本部長（両To）宛へ変更。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:637`
- `sendReminderEmails`
  - 変更: 間隔通知から、期限10日前1回通知へ変更。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:792`
- `sendApprovalRequestEmails`
  - 変更: 承認フォームURL送付から、確認用シート入力依頼へ変更。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:1558`
- `applyApprovalDecisions`
  - 変更: フォーム回答反映から、確認用シートの `専務判断` 反映へ変更。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:1697`
- `protectSenmuColumns`（新規）
  - 追加: 確認用シートの `専務判断` / `専務コメント` 列に範囲保護を設定する。
  - 想定配置: `/Users/yushi/work/work/クラハシ/src/main.ts`（保護関連関数群）

### 6.3 廃止対象（不要）
- 部署マスタ通知依存（`loadDeptMaster` と部署単位宛先参照）
  - 不要理由: 通知先は全社固定（本部長/副本部長）になるため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:3036`
- 3シート統合前提
  - 対象: `SOURCE_SHEETS` と `syncVehicles` の3元統合ロジック
  - 不要理由: 台帳は `車両一覧` へ統合し、単一シート参照にするため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:19`, `/Users/yushi/work/work/クラハシ/src/main.ts:342`
- 一次確認フォーム生成/回答回収
  - 対象: `createRequestForms`, `onRequestFormSubmit`, `extractAnswersFromFormResponse`, `closeRequestForms`, `reopenRequestForms`
  - 不要理由: 確認用シートで回答運用するため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:3294`, `/Users/yushi/work/work/クラハシ/src/main.ts:1060`
- 承認フォーム生成/回答回収
  - 対象: `createOrUpdateApprovalForm`, `onApprovalFormSubmit`, `ensureApprovalFormSubmitTrigger`
  - 不要理由: 専務判断をシート入力に統一するため。
  - 参照: `/Users/yushi/work/work/クラハシ/src/main.ts:3362`, `/Users/yushi/work/work/クラハシ/src/main.ts:1111`

## 7. 実装方針（段階導入）
### フェーズ1: 台帳一本化と設定拡張
1. 台帳参照を `車両一覧` のみに変更する。
2. `SOURCE_SHEETS` / `車両（統合ビュー）` 依存を外す。
3. 設定項目を追加する。
- 本部長副本部長_通知先To（2名分をカンマ区切り）
- 専務_通知先To/Cc
- 半期送付日_3月（既定: 03-01）
- 半期送付日_9月（既定: 09-01）
- 回答期限_3月（既定: 03-31）
- 回答期限_9月（既定: 09-30）
- リマインド_期限前日数（既定: 10）

### フェーズ2: 半期バッチと確認用シート
1. 半期バッチ管理シート（例: `通知バッチ`）を追加する。
2. `createRequests` を半期バッチ生成処理へ置換する。
3. `本部長副本部長確認_YYYYMMDD` シートを自動生成する。
4. シート生成直後に `専務判断` / `専務コメント` 列へ保護を適用する。

### フェーズ3: 通知と承認
1. 初回通知を本部長/副本部長（両To）へ送る。
2. 期限10日前・未完了のみ1回リマインドを送る。
3. 全件確認済みで専務へ承認依頼メールを送る。
4. 専務判断列（承認/差戻し）を取り込み、状態遷移を更新する。
5. 保護逸脱対策として、承認取込前に列保護を再適用する。

### フェーズ4: 村田主任入力とマスター反映
1. 更新/解約ごとの必須入力を検証する。
2. `車両一覧` へ反映する。
- 更新: 契約開始日 / 契約満了日を上書き
- 解約: 行全体をグレーアウト
3. 反映済みフラグ・反映日時を記録し、再反映を防止する。

## 8. 変更対象ファイル（予定）
- `/Users/yushi/work/work/クラハシ/src/main.ts`
- `/Users/yushi/work/work/クラハシ/docs/business_flow_vehicle_lease_renewal.md`
- `/Users/yushi/work/work/クラハシ/docs/operation_manual_vehicle_lease_renewal.md`

## 9. テスト計画（最小必須）
1. 3月便抽出テスト
- 10月〜3月対象 + それ以前の未処理が抽出されること。
2. 9月便抽出テスト
- 4月〜9月対象 + それ以前の未処理が抽出されること。
3. 通知テスト
- 初回通知が本部長/副本部長の両Toに送られること。
4. リマインドテスト
- 期限10日前に未完了の場合のみ1回送信されること。
5. 承認テスト
- 専務のシート入力（承認/差戻し）が状態へ反映されること。
6. マスター反映テスト
- 更新時の日付上書き
- 解約時の `車両一覧` 行グレーアウト
- 反映済みの二重実行防止
7. 権限保護テスト
- 専務以外ユーザーが `専務判断` / `専務コメント` 列を編集できないこと。
- 専務ユーザーは同列を編集できること。
- 日次実行後も保護が維持されること。

## 10. リスクと対策
- リスク: 半期レンジ以前を拾う仕様で対象件数が増え、処理時間が伸びる。
- 対策: 「未処理」判定を必須化し、同一車両の再抽出を抑制する。
- リスク: シート入力漏れで反映が止まる。
- 対策: 必須列の検証エラーを確認用シートに明示し、対象行だけ差し戻せるようにする。
- リスク: 旧フローと新フローの混在。
- 対策: 新フロー有効フラグを導入し、旧フォーム関数を段階的に無効化してから削除する。
- リスク: シート再生成時に保護が外れる。
- 対策: `protectSenmuColumns` を「シート生成直後」と「日次処理時」の2箇所で実行する。

## 11. 実装タスク分解（この計画書から着手する順）
1. スキーマ変更
- 設定項目（本部長副本部長_通知先To、専務_通知先To/Cc、半期日付、期限、リマインド日数）を `SETTINGS_DEFAULTS` と `loadSettings` へ追加。
2. 台帳一本化
- `SOURCE_SHEETS` 依存を除去し、`車両一覧` 単一参照に置換。
3. 半期バッチ生成
- 固定半期レンジ + 過去未処理回収で対象抽出。
- 確認用シート生成と行投入。
4. 列保護実装
- `protectSenmuColumns(sheet, settings)` を新設。
- `専務判断` / `専務コメント` 列の range protection を設定。
5. 通知実装
- 本部長/副本部長（両To）初回通知。
- 期限10日前の1回リマインド。
- 全件確認済み時の専務通知。
6. 承認反映とマスター更新
- 専務列入力を反映。
- 村田主任入力検証後に `車両一覧` へ上書き/グレーアウト反映。
7. テストと運用導線更新
- `runTestSuite` に抽出・通知・保護・反映の検証追加。
- 運用ドキュメントを新フローに合わせて更新。

## 12. 実装完了条件（Definition of Done）
1. 3月便/9月便の対象抽出が仕様どおりに動作する。
2. 本部長/副本部長への通知、10日前リマインド1回、専務通知が再現できる。
3. `専務判断` / `専務コメント` 列が専務以外から編集できない。
4. 専務判断と村田主任入力を経て、`車両一覧` へ正しく反映できる。
5. 旧フォーム依存の主要経路が無効化または撤去され、運用が混在しない。
