# 実装計画書: 車両リース契約 更新通知（GAS）

- 作成日: 2026-01-18
- 対象: `data/車両管理 (2).xlsx` をインポートした Google スプレッドシート + Apps Script（GAS）
- 目的: 契約満了が近い車両を抽出し、管理部署へ通知→Webで回答回収→台帳へ反映（人手最小化）
- 関連資料:
  - `docs/about_this_project.md`
  - `docs/vehicle_management_structure.md`
  - `docs/sheet_schema_management_rules.md`
  - `docs/business_flow_vehicle_lease_renewal.md`

## 1. 目的 / 成功条件
- 目的:
  - 契約満了が近い車両を、漏れなく部署ごとに通知する
  - 部署からの「再リース/新車入替/廃止/未定」の回答をオンラインで回収し、集計できるようにする
  - 回答結果を台帳（元台帳）に反映できるようにする
- 成功条件（受け入れ条件）:
  - 契約満了日が「本日〜本日+6か月」の車両が抽出される（列番号固定はせず、ヘッダ名で解決する）
  - 管理部門（ヘッダ名 `管理部門`）ごとに、通知先メールへ初回メールが送られる
  - メール内リンクからWeb画面で回答でき、未回答/回答済みが判定できる
  - リマインド条件（間隔/最大回数など）がシートの設定で後から変更できる
  - 回答集計が「シート」と「管理者メール」の両方で確認できる（設定でON/OFF可能）
  - 元台帳（`車両一覧` / `車両一覧【ｹﾝｽｲ】` / `車両一覧【ﾈｸｽﾄ】`）に回答結果（更新方針など）が追記列として反映される

## 2. 非目的（今回やらないこと）
- リース会社への連絡（営業メモ③）はGASで自動送信しない（必要なら集計資料の作成まで）
- Excel元ファイル自体の自動同期（インポート後のSheetsを正とする前提）
- 監査ログ/承認ワークフローの厳密化（必要なら次フェーズ）

## 3. 前提 / 制約
- 入力データは「Excelをそのままスプレッドシートにインポート」したものを基本とする（ただし構造整理は許容）
- 対象シートは以下を含む（統合前提）:
  - `車両一覧`
  - `車両一覧【ｹﾝｽｲ】`
  - `車両一覧【ﾈｸｽﾄ】`
- 抽出条件: 契約満了日が「本日〜本日+6か月」の範囲
  - 期限計算は **180日ではなく「月加算」** とする（例: 2026-01-18 → 2026-07-18）
  - 端数（例: 8/31 + 6か月 → 2月末）: 加算後の月に同日が存在しない場合は **その月の末日** とする
- 比較はスプレッドシートのタイムゾーンにおける「日付（00:00固定）」として扱い、範囲は **両端を含む**（start/end inclusive）
- 回答方式: Web（GAS Webアプリ）で回答（制約次第でGoogleフォームへ切替）
- 通知先は `部署マスタ`（管理部門→メールアドレス）で管理
- 反映先: **元台帳（sourceSheet）の該当行**へ反映する（`車両一覧` / `車両一覧【ｹﾝｽｲ】` / `車両一覧【ﾈｸｽﾄ】`）
  - 既存列は変更せず、右端に「追記列」を追加して反映する（例: `更新方針` / `依頼ID` / `回答日` / `備考`）
  - 併せて `車両（統合ビュー）` にも反映し、集計/検索は統合ビューを正とする
  - 将来的に `更新` シート連携の可能性あり
- Web回答の認証/アクセス制御: 社内Googleログイン必須は難しいため、リンク + トークン方式で行う
- 管理部門の表記ゆれ: `部署マスタ` 側で表記統一し、運用上の正をそこに置く
- `契約満了日` が無い車両: 抽出対象外にしつつ「要入力リスト化」する
- 集計出力: MVP段階から「集計シート作成」＋「管理者向けサマリメール送信」の両方を行う（設定で可変）

## 4. 現状（調査結果 / As-Is）
- `車両一覧` の主要列（Excel時点）
  - 契約満了日: J列（ヘッダ名 `契約満了日`）
  - 管理部門: W列（ヘッダ名 `管理部門`）
- 登録番号は複数列に分割されている（地名/分類番号/かな/番号）
- `車両一覧【ｹﾝｽｲ】` は契約関連が空の行が多い（満了日が無い可能性がある）

## 5. To-Be（方針 / 設計概要）
### 5.1 データ設計（シート案）
既存タブは「インポート結果として保持」しつつ、GAS運用のために追加タブを持つ。

- `設定`
  - `抽出_満了まで月数`（例: 6）
  - `通知_実行頻度`（日次/週次など）
  - `リマインド_初回から日数` / `リマインド_間隔日数` / `リマインド_最大回数`
  - `締切_初回送信から日数`（例: 14。`更新依頼.締切日` の算出に使用）
  - `送信元名` / `件名テンプレ` / `本文テンプレ`
  - `Web回答URL（デプロイURL）`
  - `管理者_通知先To` / `管理者_通知先Cc`（集計サマリ送信用）
  - `集計_シート出力`（TRUE/FALSE）
  - `集計_メール送信`（TRUE/FALSE）
- `部署マスタ`
  - `管理部門`（例: 水産部/物流部/ｹﾝｽｲ/ﾏﾘﾝﾈｸｽﾄ）
  - `通知先To`（メール）
  - `通知先Cc`（任意）
  - `有効`（TRUE/FALSE）
  - `部門トークン`（Web回答の簡易認証に利用。十分に長いランダム値）
- `車両（統合ビュー）`（=正規化した一覧、生成/更新はGAS）
  - `vehicleId`（一意キー）
  - `sourceSheet`（元シート名）
  - `登録番号_地名` / `分類` / `かな` / `番号` / `登録番号_結合`
  - `車種` / `車台番号`
  - `契約満了日` / `契約開始日`（あれば）
  - `管理部門`
  - `更新方針`（反映値: 再リース/新車入替/廃止/未定）
  - `依頼ID` / `回答日` / `備考`
- `要入力`（データ不備の見える化）
  - `検出日時` / `sourceSheet` / `vehicleId` / `管理部門` / `登録番号_結合` / `車種`
  - `不備内容`（例: 契約満了日なし、管理部門なし、部署マスタ未登録など）
- `更新依頼`（部署単位の依頼バッチ）
  - `requestId`、`管理部門`、`対象開始日`、`対象終了日`、`締切日`、`ステータス`（送信済/回答中/締切/完了）
  - `初回送信日時`、`最終リマインド日時`、`リマインド回数`
  - `requestToken`（依頼単位のトークン。メールURLに埋め込む）
- `回答`（車両単位の回答）
  - `requestId`、`vehicleId`、`回答`（再リース/新車入替/廃止/未定）、`コメント`、`回答者`、`回答日時`
- `通知ログ`
  - `日時`、`種別`（初回/リマインド）、`管理部門`、`宛先`、`requestId`、`結果`（成功/失敗、エラー）
- `回答集計`（管理者向けビュー）
  - `requestId` / `管理部門` / `対象期間` / `総件数`
  - `再リース` / `新車入替` / `廃止` / `未定` / `未回答`
  - `最終更新日時`

### 5.2 車両の一意キー（vehicleId）
- 第1候補: `登録番号_結合 + sourceSheet(または会社区分)`（車台番号が無いケースがあるため）
- `車台番号` がある場合は併記して、将来の名寄せに利用

### 5.3 Web回答（リンク + トークン方式）
- URL例: `.../exec?requestId=...&token=...&dept=...`（実際のパラメータは要調整）
- 検証:
  - `requestId` の存在
  - `requestToken` の一致
  - `dept`（管理部門）と `更新依頼.管理部門` の一致
  - `部署マスタ` に `dept` が存在し、`部門トークン` が一致（防御を二重化）
- 注意:
  - リンク転送/第三者閲覧のリスクは残るため、トークンは十分長いランダム値にする
  - 完了後は `requestToken` を無効化（ステータスを完了にし、Webから閲覧不可にする）

### 5.4 代替案: Googleフォームで回答（GAS Webアプリを使わない）
- クライアントWorkspaceの制約で Webアプリ（`/exec`）が運用できない場合の代替。
- 依頼（requestId）ごとにフォームを作成し、メールにはフォームURLを記載する。
- フォーム送信トリガーで `回答` へ取り込み → `applyAnswers()` → `回答集計` を更新する。
- 車両数が多い部署を想定し、更新方針は「選択式グリッド」、必要ならフォーム分割（Part1/Part2…）を前提にする。
- 詳細仕様: `docs/spec_vehicle_lease_renewal_answer_via_google_forms.md`

### 5.5 処理フロー（MVP）
1. `車両（統合ビュー）` を同期（3つの車両一覧から正規化・集約）
2. 抽出: 契約満了日が「本日〜本日+6か月」かつ未依頼/未完了の車両を対象化
3. 部署ごとに `更新依頼` を作成し、メール送信（Web回答URLを埋め込む）
4. Webで回答→ `回答` に保存→ `車両（統合ビュー）` と元台帳（追記列）へ反映
5. 未回答が残る部署にリマインド（`設定` により可変）
6. 車両管理者向けに「部署別/車両別の回答集計」を見られる状態にする（シート + メール。設定でON/OFF）

## 6. 実装ステップ（手順）
### フェーズ1: 最小の価値（①②④）
1. シートスキーマをコードで管理する（`docs/sheet_schema_management_rules.md` の方針に従う）
2. スプレッドシートに `設定` / `部署マスタ` / `車両（統合ビュー）` / `要入力` / `更新依頼` / `回答` / `通知ログ` を追加（不足は `syncSchema()` で非破壊作成）
3. Apps Script（スプレッドシートに紐づけ）で以下を実装
   - スキーマ同期/ドリフト検知: `syncSchema()` / `checkSchemaDrift()`
   - 正規化同期: `syncVehicles()`（ヘッダ名ベースで列位置を解決、欠損は `要入力` へ）
   - 抽出/依頼作成: `createRequests()`（二重送信防止、トークン発行を含む）
   - メール送信: `sendInitialEmails()`（部署マスタ参照、部署単位で1通にまとめる）
   - Web回答: `doGet()` / `doPost()`（リンク+トークン検証）※ Webアプリ運用可能な場合
   - フォーム回答（代替）: フォーム作成 + フォーム送信トリガーで取り込み（`docs/spec_vehicle_lease_renewal_answer_via_google_forms.md`）
   - 反映: `applyAnswers()`（元台帳 `sourceSheet` 側の追記列へ反映。既存列は変更しない）
   - 集計: `buildSummarySheet()`（`回答集計` を更新）
   - 集計通知: `sendSummaryEmail()`（`管理者_通知先To/Cc` 宛）
4. 時間主導トリガー（例: 平日朝）を設定
5. 手動実行用のカスタムメニュー（管理者向け）を追加

### フェーズ2: 運用改善（リマインド/集計/更新シート）
1. リマインドロジック（設定で変更可能）
2. 回答集計ビューの拡張（期限順、未回答一覧、詳細ドリルダウン等）
3. `更新` シート（進捗）への反映/行生成（要件が固まってから）

## 7. リスクと対策（暫定）
- データ欠損（特に `車両一覧【ｹﾝｽｲ】` の満了日なし）:
  - 対策: 満了日が無い車両は抽出対象外にして「要入力」リストへ出す
- 列構造変更（列番号依存の破綻）:
  - 対策: J列/W列固定ではなくヘッダ名で列を解決する
- Web回答のなりすまし:
  - 対策: リンク+トークン（部署トークン + 依頼トークン）で検証し、完了後は無効化する
- GASの送信クォータ:
  - 対策: 送信件数を部署単位メール（1通に複数車両）に寄せる、送信ログで失敗を可視化

## 8. 残タスク / 追加確認事項
- 結果反映列は `更新方針` / `依頼ID` / `回答日` / `備考` とする（元台帳の右端へ追記）
- “締切” は導入する（`更新依頼.締切日` と `設定.締切_初回送信から日数` を使用）
- トークンの運用（再発行/無効化タイミング/漏洩時の復旧手順）を確定
