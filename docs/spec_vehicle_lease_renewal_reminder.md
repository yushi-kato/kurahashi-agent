# 仕様書: 車両リース契約 更新通知ツール（リマインド通知）

- 作成日: 2026-01-20
- 対象: 車両リース契約 更新通知（GAS / Googleフォーム回答）
- 関連:
  - `docs/about_this_project.md`
  - `docs/operation_manual_vehicle_lease_renewal.md`
  - `src/main.ts`

## 1. 目的 / 成功条件

### 目的
- 初回通知メール（部署単位）を送った後、未回答が残っている部署に対して自動でリマインドを送り、回収率を上げる。
- リマインドの間隔・最大回数を `設定` シートで後から変更できるようにする。

### 成功条件（受け入れ条件）
- `更新依頼` のステータスが「送信済」「回答中」かつ未回答が残る依頼に対し、条件を満たす場合にリマインドメールを送る。
- リマインド送信時に `更新依頼` の `最終リマインド日時` と `リマインド回数` が更新される（仕様で定義した更新ルールに従う）。
- 送信結果が `通知ログ` に記録される（種別=リマインド）。
- 締切日を過ぎた依頼は期限超過として扱い、管理者へ通知し、リマインドは止める（フォームは閉じない）。

## 2. 非目的（今回やらないこと）
- 個人単位（Toの複数人への個別追跡）のリマインド最適化（本ツールは部署単位送信が前提）。
- 既存の初回メール送信テンプレの大幅な刷新（必要なら別spec）。
- Slack/Chatツール連携などメール以外の通知。

## 3. 前提 / 制約
- 通知は部署単位で行う（`部署マスタ.通知先To/Cc`）。
- 回答はGoogleフォームで受け付ける（Webアプリの `doGet/doPost` は廃止メッセージを返す）。`src/main.ts:584`
- `更新依頼` には初回/リマインド用の管理列が存在する（`初回送信日時` / `最終リマインド日時` / `リマインド回数`）。`src/main.ts:70`
- リマインド関連の設定値は `設定` シートで管理する（`リマインド_初回から日数` / `リマインド_間隔日数` / `リマインド_最大回数`）。`src/main.ts:130`

## 4. 現状（As-Is）
- 自動送信は `sendInitialEmails()` による「初回」中心で、リマインド送信ロジックは未実装。`src/main.ts:443`
- `runDaily()` は `createRequests()` → `sendInitialEmails()` まで実行するが、リマインド送信は呼ばない。`src/main.ts:844`
- 運用マニュアル上も「未回答リマインドは運用でカバー」と記載がある。`docs/operation_manual_vehicle_lease_renewal.md:17`

## 5. To-Be（仕様 / 挙動）

### 5.1 対象の定義
- **依頼（request）**: `更新依頼` の1行（部署単位）。
- **未回答が残る**: `車両（統合ビュー）` のうち `依頼ID=requestId` の車両で、`更新方針` が空のものが1件以上ある。

### 5.2 リマインド送信の対象ステータス
- 対象: `更新依頼.ステータス` が `送信済` または `回答中`
- 対象外:
  - `作成済`（まだ初回送信していない前提）
  - `完了`（全車両回答済み）
  - `締切`（締切日超過。ステータスを締切にしない運用でも「締切日超過」は対象外）

※ ステータスは「集計時点の車両回答状況」から再計算して扱う（`updateRequestStatus()` 相当のロジック）。`src/main.ts:2523`

### 5.3 リマインド送信の条件（スケジュール）
以下をすべて満たすときに、その依頼へリマインドメールを送る。

1. `通知_メール送信=TRUE`
2. `リマインド_最大回数 > 0`
3. `初回送信日時` が存在する（初回送信済み）
4. `締切日` が存在する場合、**本日が締切日以前**（締切超過なら期限超過として扱い、管理者へ通知してリマインド対象外）
5. 未回答が残っている
6. リマインド回数の上限未満:
   - `リマインド回数 < リマインド_最大回数`
7. 送信タイミング:
   - 初回リマインド: `本日 >= 初回送信日時 + リマインド_初回から日数`
   - 2回目以降: `本日 >= 最終リマインド日時 + リマインド_間隔日数`

日付比較は、スプレッドシートのタイムゾーンで「日付（00:00）」に丸めて行う（同日に複数回送らないため）。

### 5.4 メール内容（案）
#### 件名
- 既存の `件名テンプレ` を流用しつつ、先頭に `【リマインド】` を付与する。
  - 例: `【リマインド】【車両更新確認】{{管理部門}} ...`

#### 本文
- 既存の `本文テンプレ` を流用する。
- `対象車両` の列挙は、以下のどちらにするかを決める（判断ポイント）。
  - A) 全対象車両を再掲（初回と同等）
  - B) **未回答の車両のみ**を掲載（推奨: ノイズ削減）

#### 回答URL
- 初回と同じく、依頼に紐づくGoogleフォームURL（複数分割時は全URL）を掲載する。

### 5.5 送信後のデータ更新
- 送信成功時:
  - `更新依頼.最終リマインド日時` = 送信時刻
  - `更新依頼.リマインド回数` = 現在値 + 1
  - `通知ログ` に 1 行追加（種別=`リマインド`、結果=`成功`）
- 送信失敗時:
  - `通知ログ` に 1 行追加（結果=`失敗: ...`）
  - `最終リマインド日時` / `リマインド回数` を更新するかは判断ポイント（推奨: **更新しない**。ただし失敗が毎日繰り返される懸念あり）

### 5.6 締切超過時の扱い（決定）
- `本日 > 締切日` の依頼は「期限超過」として扱い、**リマインド送信対象外**とする。
- 期限超過になった旨を **管理者（adminTo）へ通知する**（部署へは通知しない）。
- **フォームは閉じない**（期限超過後も回答は受け付ける）。
- `更新依頼.ステータス` を `締切` にするかどうかは実装時に決める（見える化のために `締切` を使う想定だが、回答が入った場合の遷移と整合が必要）。

## 6. 決定事項

| ID | 決定事項 | 採用案 |
|---|---|---|
| 1 | リマインド自動送信の実行タイミング | A) `runDaily()` の末尾に追加 |
| 2 | リマインド本文に載せる車両一覧 | B) 未回答の車両のみ |
| 3 | 送信失敗時の `リマインド回数` 更新 | A) 成功時のみ増やす |
| 4 | 締切超過時の通知先 / フォーム扱い | C) 管理者へ通知、フォームは閉じない |

## 7. 判断ポイント（未確定があれば追記）

### Q1. リマインドを自動送信する実行タイミング
- 背景: 現状は `runDaily()` が平日朝のトリガー想定。`src/main.ts:844`
- 選択肢:
  - A) `runDaily()` の末尾にリマインド送信を追加（推奨: 実行箇所が1つで分かりやすい）
  - B) 別の時間主導トリガー（例: 平日 12:00）でリマインド専用処理を動かす
- 影響: トリガー管理、同日内の送信タイミング、運用の分かりやすさ
- 決定: A

### Q2. リマインド本文に載せる車両一覧
- 背景: 初回メールは対象車両をすべて列挙している。`src/main.ts:521`
- 選択肢:
  - A) 全対象車両を再掲
  - B) 未回答の車両のみ（推奨）
- 影響: 受信者の読みやすさ、誤対応（既回答を再度触ってしまう）のリスク
- 決定: B

### Q3. 送信失敗時に `リマインド回数` を増やすか
- 背景: 失敗が続くと毎日送信を試みてログが増える可能性がある。
- 選択肢:
  - A) 成功時のみ増やす（推奨）
  - B) 試行（成功/失敗問わず）で増やす（無限試行は防げるが、成功機会を捨てることがある）
- 影響: 運用負荷（ログ量）と、通知到達率
- 決定: A（必要なら将来「失敗回数」列を追加）

### Q4. 締切超過時に部署へ通知するか
- 背景: 現状は締切の自動扱いが未整備。`src/main.ts:2523`
- 選択肢:
  - A) 締切にしたらフォームを閉じ、通知はしない
  - B) 締切になった旨を部署へ通知する
  - C) 締切になった旨を管理者（adminTo）へ通知する
- 影響: 誤送信/クレーム、運用の透明性
- 決定: C（フォームは閉じない）

## 8. 実装方針（メモ）
- `sendInitialEmails()` と同等のメール組み立てを流用し、「リマインド」用に対象依頼を絞って送る関数を追加する。
- 依頼ステータス再計算（送信済/回答中/完了/締切）を日次で行う（依頼一覧ループで集計）。
- 変更後は運用マニュアルの「未回答リマインドは運用でカバー」の記述を更新する。

## 9. 未解決 / 追加の確認事項
- `締切日` が空の既存行がある場合の扱い（空なら締切チェックをスキップする/強制補完する）。
- `部署マスタ` のTo/Ccが変更された場合、リマインドは常に最新のTo/Ccで送る前提で良いか。
- 依頼が再送（手動でステータスを「作成済」に戻す）された場合の `リマインド回数` のリセット有無。
