# 仕様案: 車両更新通知の回答回収を Googleフォームで行う（GAS Webアプリ不使用）

- 作成日: 2026-01-19
- 背景: クライアントWorkspaceの制約で「GAS Webアプリ（`/exec`）を外部公開できない/運用できない」前提
- 前提: Googleフォームは「リンクを知っている外部ユーザーが回答できる」設定で運用できる（= フォーム自体の外部回答が禁止されていない）

## 1. 目的 / 成功条件

- 目的:
  - 部署ごとにメール通知し、外部ユーザー（Googleアカウント不要の可能性）から回答を回収する
  - 回答結果を `回答` シートに格納し、`車両（統合ビュー）` と元台帳へ反映し、`回答集計` を更新する
- 成功条件:
  - 依頼（requestId）単位でフォームURLが発行され、メールに埋め込まれる
  - フォーム送信1回で、その依頼に含まれる車両すべての「更新方針」が保存される（未定を含む）
  - `回答` → 反映（`applyAnswers()`）→ `回答集計` が自動で更新される（フォーム送信トリガー）

## 2. 非目的

- フォーム回答者の厳密な本人認証（Googleログイン必須化など）
- Web UI のリッチな入力体験（Webアプリの代替なので最小）

## 3. 全体フロー（To-Be）

1) `日次一括実行`（または同等のバッチ）で、対象車両を部署ごとにまとめて `更新依頼` を作成  
2) 依頼ごとに Googleフォームを作成（またはテンプレから複製）し、フォームURLを `更新依頼` に保存  
3) 部署宛に「フォームURL」をメール送信  
4) 回答者がフォーム送信  
5) フォーム送信トリガーで回答を `回答` に upsert → `applyAnswers()` → `回答集計` 更新  
6) 全車両が回答済み扱いになったら `更新依頼` を完了にし、フォームを回答停止（任意）

## 4. データ設計（シート/列）

既存の `更新依頼` / `回答` を活かしつつ、フォーム連携に必要な列を追加する。

### 4.1 `更新依頼`（追加列案）

- `formId`（作成したGoogleフォームID、単一フォームの場合）
- `formUrl`（回答用URL、単一フォームの場合）
- `formIdsJson`（分割時のフォームID配列JSON、任意）
- `formUrlsJson`（分割時のフォームURL配列JSON、任意）
- `formEditUrl`（運用者向けの編集URL、単一フォームの場合の便利枠、任意）
- `formTriggerId`（フォーム送信トリガーID、単一フォームの場合の便利枠、任意）
- `フォーム作成日時`（任意）

※ 既存の `requestToken` / `deptToken` は「リンク+トークン」方式の名残として残してもよいが、
フォーム方式では **formId→requestId の紐付けで十分**（= URLにトークンを含めなくても処理できる）。

### 4.2 `回答`（既存のまま）

- `requestId`、`vehicleId`、`回答`、`コメント`、`回答者`、`回答日時`

## 5. フォーム設計（依頼=1フォーム）

### 5.1 フォームの基本項目

- フォーム名: `【車両更新方針】<管理部門> <requestId>`
- 説明文: 対象期間、締切、注意事項（転送禁止など）
- 回答の確認メッセージ: `回答を受け付けました。ありがとうございました。`

### 5.2 入力項目（推奨）

1) `回答者（任意）`（短文）
2) `更新方針（車両ごと）`（**選択式グリッド**、必須）
   - 行: 車両（後述の `vehicleId` を埋め込んだ行ラベル）
   - 列: `再リース` / `新車入替` / `廃止` / `未定`
3) `コメント（任意）`（段落、任意）
   - 方式A（簡単）: 部署/依頼全体のコメント
   - 方式B（車両別コメントを残したい）: `vehicleId: コメント` を改行で列挙（例: `V-xxx: タイヤ交換予定`）

車両表示名（例）: `<登録番号> / <車台番号> / 満了日:YYYY-MM-DD`

### 5.3 車両IDとの紐付け（必須）

フォームの「行ラベル」に `vehicleId` を埋め込み、サーバ側で確実に復元できるようにする。

- 例:
  - `|<vehicleId>| <表示名>`

### 5.4 制約（運用前に確認）

- フォームの設問数には上限があるため、依頼に含まれる車両数が極端に多い部署がある場合はガードが必要
  - 対策: 更新方針を「選択式グリッド」に集約し、コメントは全体コメント（または `vehicleId: コメント` 形式）に寄せる
- 車両数が多すぎる場合は `MAX_VEHICLES_PER_FORM` を設けて **フォームを分割**する（同一requestIdで Part1/Part2…）
- 依頼ごとにフォームを作る場合、フォーム送信トリガーが増える
  - 完了後にフォームを回答停止し、トリガー削除する運用（または定期掃除）を前提にする

## 6. 回答取り込み（フォーム送信トリガー）

### 6.1 トリガー方式

- 原則: `ScriptApp.newTrigger('onRequestFormSubmit').forForm(form).onFormSubmit().create()`
- `formId` をキーに `更新依頼.formId`（または `formIdsJson`）から `requestId` を逆引きする
- 分割時: どのフォームが送信されても同じ `requestId` の回答として取り込む

### 6.2 取り込み処理

- `e.response.getItemResponses()`（または `e.namedValues`）を走査し、行ラベル/設問ラベルから `vehicleId` を復元する
- 車両ごとの「更新方針」をまとめて `AnswerInput[]` を構築（コメントは全体コメント or `vehicleId: コメント` 形式から復元）
- `upsertAnswers(answerInputs)` → `applyAnswers()` → `buildSummarySheet()` を実行
- `更新依頼` のステータス更新:
  - フォーム設計で「全車両の更新方針を必須」にしているため、送信1回で原則「完了」（分割時は全フォーム分が揃ったら完了）
  - 再回答（修正）を許可する場合は、最新回答で上書きする（`answeredAt` の新しいものを採用）

### 6.3 フォームの締切・無効化（任意）

- `更新依頼` が完了したら `form.setAcceptingResponses(false)` で回答停止
- 完了後にトリガーを削除（運用上の上限回避）

## 7. セキュリティ/リスク（フォーム前提）

- フォームURLは「リンクを知っている人が回答できる」前提になるため、転送されると第三者回答のリスクがある
  - 対策（最低限）: メール本文とフォーム説明文で転送禁止を明記
  - 対策（任意）: `部署トークン`（合言葉）入力欄を追加し、取り込み時に一致チェック（ただし運用負荷増）
- 回答者の本人確認は厳密にはできない（Googleログインを使わない前提のため）
  - 代替: `回答者` 欄に氏名/部署/連絡先を任意入力してもらう

## 8. 運用（作業手順の差分）

- 送信側（運用者）:
  - `日次一括実行` → `更新依頼.formUrl` が発行され、メールが送られる
  - `通知ログ` と `更新依頼` のステータスを確認
- 回答側（部署/外部）:
  - メールのフォームURLを開く → 更新方針を選ぶ → 送信
- 確認:
  - `回答` シートに記録が入る
  - `回答集計` が更新される
  - 元台帳と `車両（統合ビュー）` に反映される

## 9. 実装メモ（既存コードへの置き換えポイント）

- `doGet()` / `doPost()` を使うWeb回答フローを停止/非推奨にする（メニューから呼ばない、設定で無効化など）
- `sendInitialEmails()` のURL組み立てを `更新依頼.formUrl` に切り替える
- `onRequestFormSubmit()`（新規）を追加し、`upsertAnswers()` / `applyAnswers()` / `buildSummarySheet()` を再利用する
