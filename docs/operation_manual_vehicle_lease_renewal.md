# 運用マニュアル（クライアント向け）: 車両リース契約 更新通知ツール

このドキュメントは、スプレッドシート上で「契約満了が近い車両」を部署へ通知し、Webで回答を集め、台帳へ反映するための**日常運用手順**をまとめたものです。

（作成日: 2026-01-18）

---

## 1. このツールでできること（ざっくり）
1) 満了が近い車両を自動で拾う（例: 6か月以内）  
2) 管理部門へメールで「回答リンク」を送る（部署ごとに1通）  
3) 各部署はWeb画面で「更新方針」を回答する（再リース/新車入替/廃止/未定）  
4) 回答結果をスプレッドシート（台帳）へ反映する  
5) 部署別の集計（回答集計）を確認できる（必要なら管理者へサマリメール）

補足:
- 初回メール送信後、未回答が残っている部署には、設定に従ってリマインドメールが自動送信されます（最大回数まで）。

---

## 2. 触る場所（タブ）
普段よく見るのは次のタブです。

- `車両一覧` / `車両一覧【ｹﾝｽｲ】` / `車両一覧【ﾈｸｽﾄ】`（元台帳）
  - ここにある「契約満了日」「管理部門」などを元に判定します
  - 回答結果は、右端に列が追加されて書き戻されます（後述）
- `要入力`
  - 「契約満了日が無い」「管理部門が無い/未登録」など、通知できない原因が一覧で出ます
- `更新依頼`
  - 部署ごとの依頼（requestId）と、進み具合（ステータス）が入ります
- `通知ログ`
  - メール送信の成功/失敗が記録されます（まずここを見る）
- `回答集計`
  - 部署別の回答数（再リース/新車入替/廃止/未定/未回答）が見られます

---

## 3. 回答する人（各管理部門）の手順
メールが届いたら、次だけやればOKです。

1) メール内の「回答URL」を開く  
2) 画面で、車両ごとに「更新方針」を選ぶ  
3) 必要なら「コメント」を入れる（任意）  
4) 最後に「回答を送信」を押す  

注意:
- できるだけ**対象の車両すべて**に回答してください（未入力が残ると「未回答」として集計に残ります）。
- 回答URLは社内情報です。**社外へ転送しないでください**。
- 送信後に画面が「受付しました」になれば完了です。

---

## 4. 運用担当（車両管理者）の毎日のやること
### 4.1 基本（平常運転）
- 原則、平日朝に自動で動きます（目安: 平日 8:00）。
- 管理者宛のサマリメールが来ていれば、まずはその内容を確認します。
- スプレッドシートで見る場合は `回答集計` を開き、未回答が残っている部署がないか確認します。

必要なときだけ手動実行:
- すぐに最新化したい場合は、メニュー `車両更新通知` → `日次一括実行` を押します（当日の処理をまとめて実行します）。

### 4.2 未回答が残っているとき
- `回答集計` の「未回答」が残っている部署があれば、まず状況を確認します（リマインドは設定に従い自動送信されます）。
- リマインド回数の上限に達しても未回答が残る場合は、社内の通常連絡で督促します。
- 必要なら、該当部署へ「通知メールの再送」や「リンク再共有」をします（手順は「困ったとき」を参照）。

---

## 5. 初期設定（最初に1回だけ）
※ここは「スプレッドシートの管理者」向けです。設定済みなら飛ばしてください。

### 5.1 メニューが出ることを確認
スプレッドシートを開くと、上部メニューに `車両更新通知` が出ます。

初回は権限確認が出ることがあります。案内に従って許可してください。

### 5.2 必要タブを作る（スキーマ同期）
メニュー `車両更新通知` → `スキーマ同期`

これで運用タブ（`設定` / `部署マスタ` / `更新依頼` など）が作られます。

### 5.3 部署マスタを入れる（通知先の管理）
タブ `部署マスタ` に、部署ごとに次を入れます。
- 管理部門（台帳の表記と揃える）
- 通知先To（メールアドレス）
- 通知先Cc（必要なら）
- 有効（TRUE/FALSE）

入れたら、メニュー `車両更新通知` → `部署トークン生成(空欄のみ)` を実行します。

### 5.4 設定を入れる
タブ `設定` で、最低限次を確認します。
- `抽出_満了まで月数`（通常は 6）
- `Web回答URL（デプロイURL）`（空だとメール送信できません）
- `管理者_通知先To`（サマリメールが必要な場合）
- `通知_メール送信`（TRUEで送信、FALSEで送らない）

### 5.5 自動実行（平日朝）を設定する
自動実行が必要な場合は、メニュー `車両更新通知` → `日次トリガー再作成` を実行します。

---

## 6. 困ったとき（よくある原因と対処）
### 6.1 メールが送られていない/失敗している
1) `通知ログ` を開いて、失敗理由を確認します  
2) 多い原因:
   - `部署マスタ` に部署が無い / 無効になっている
   - `通知先To` が空
   - `Web回答URL（デプロイURL）` が空

原因を直したら、メニュー `車両更新通知` → `初回メール送信` を実行します。

補足:
- 送信対象は、基本的に `更新依頼` のステータスが「作成済」のものです。
- 再送が必要な場合は、対象行のステータスを「作成済」に戻してから `初回メール送信` を実行してください（やりすぎると二重送信になります）。
- ステータスが「完了」の依頼は、リンクを無効化するため再送できません（必要なら新規依頼として取り扱います）。

### 6.2 `要入力` に出ている（通知できない車両がある）
`要入力` に出た行の「不備内容」を見て、元台帳で直します。
- `契約満了日なし` → 元台帳に満了日を入力
- `管理部門なし` → 元台帳に管理部門を入力
- `部署マスタ未登録` → `部署マスタ` に追加、または元台帳の表記を合わせる

修正後、メニュー `車両更新通知` → `車両統合ビュー同期` を実行します。

### 6.3 回答したのに台帳に反映されない
まずは `回答` タブに回答行が増えているか確認します。増えていない場合は、回答URLの問題の可能性があります。

回答が入っているのに反映が弱い場合は、メニュー `車両更新通知` → `回答反映` を実行します。

回答URLを開いたときにエラーが出る場合（例: 「パラメータが不足しています」「トークンが一致しません」「この依頼は完了しています」）は、運用担当へ連絡してください。

---

## 7. 台帳に追加される列（自動で増えます）
元台帳（`車両一覧` など）の右端に、次の列が追加されて更新されます。

- `更新方針`（再リース/新車入替/廃止/未定）
- `依頼ID`（どの依頼に紐づくか）
- `回答日`（回答が入った日時）
- `備考`（コメント）

---

## 8. やってはいけないこと
- タブ名を変更/削除しない（特に `設定` / `部署マスタ` / `更新依頼` / `回答` / `通知ログ` / `要入力` / `回答集計`）
- 1行目（見出し行）の文字を勝手に変えない
- 回答URLを社外へ転送しない
